<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class ApiController - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>../../app/controllers/api_controller.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    <nav id="sections-section" class="section">
  <h3 class="section-header">Sections</h3>
  <ul class="link-list">
    
      <li><a href="#5Buntitled-5D"></a></li>
    
      <li><a href="#BULK+API">BULK API</a></li>
    
      <li><a href="#DIVE+RELATED+API">DIVE RELATED API</a></li>
    
      <li><a href="#LIST_DIVE_DETAILS+API">LIST_DIVE_DETAILS API</a></li>
    
      <li><a href="#LIST_USER_DIVES+API">LIST_USER_DIVES API</a></li>
    
      <li><a href="#LOGIN_FB">LOGIN_FB</a></li>
    
      <li><a href="#LOGIN_email">LOGIN_email</a></li>
    
      <li><a href="#UPDATE_DIVE_DETAILS+API">UPDATE_DIVE_DETAILS API</a></li>
    
      <li><a href="#UPDATE_SPOT+API">UPDATE_SPOT API</a></li>
    
      <li><a href="#USER+RELATED+API">USER RELATED API</a></li>
    
  </ul>
</nav>

    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">ApplicationController
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-i-list_dive_details">#list_dive_details</a>
    
    <li><a href="#method-i-list_user_dives">#list_user_dives</a>
    
    <li><a href="#method-i-login_email">#login_email</a>
    
    <li><a href="#method-i-login_fb">#login_fb</a>
    
    <li><a href="#method-i-update_dive">#update_dive</a>
    
    <li><a href="#method-i-update_spot">#update_spot</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./ApiController.html">ApiController</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class ApiController</h1>

  <div id="description" class="description">
    
  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
  </section><!-- 5Buntitled-5D -->

  
  
  <section id="BULK+API" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        BULK API
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
  </section><!-- BULK+API -->

  
  
  <section id="DIVE+RELATED+API" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        DIVE RELATED API
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
  </section><!-- DIVE+RELATED+API -->

  
  
  <section id="LIST_DIVE_DETAILS+API" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        LIST_DIVE_DETAILS API
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
     <section id="public-instance-LIST_DIVE_DETAILS+API-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-list_dive_details" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">list_dive_details</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <dl class="rdoc-list label-list"><dt>General
<dd><ul><li>
<p>API url : /api/list_dive_details</p>
</li><li>
<p>Returns a list of details for asked dives</p>
</li><li>
<p>If asking not owned dives, will only return the public data</p>
</li></ul>
</dd><dt>Authentication
<dd><ul><li>
<p>Required</p>
</li><li>
<p>GET Call</p>
</li></ul>
</dd><dt>Request - case FB
<dd><ul><li>
<p><strong>token</strong> : User's Token on Diveboard (as provided by login
API)</p>
</li><li>
<p><strong>apikey</strong>: the application's API key</p>
</li><li>
<p><strong>divelist</strong>: a JSON ARRAY of integers i.e. [12,34,23]</p>
</li><li>
<p>callback: the callback function (if supplied it will be responded using
jsonp)</p>
</li><li>
<p>units: “imperial” or “si” (default)</p>
</li></ul>
</dd><dt>Response
<dd><ul><li>
<p><strong>success</strong> : boolean, false if failure</p>
</li><li>
<p>error* : string defining the error (only present if success==false)</p>
</li><li>
<p>error_tag* : uid of the error (only present if success==false)</p>
</li><li>
<p><strong>dives</strong> : a JSON string: [{dive1},...,{diven}] where dive is
a dive object:</p>

<pre class="ruby">{
  <span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">dive</span> <span class="ruby-identifier">id</span> (<span class="ruby-identifier">integer</span>)
  <span class="ruby-identifier">spot</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">spot</span> <span class="ruby-identifier">id</span>
            <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">spot</span> <span class="ruby-identifier">name</span>
            <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">country</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">spot</span> <span class="ruby-identifier">country</span>
            <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">location</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">spot</span> <span class="ruby-identifier">region</span>
            <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">region</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">spot</span> <span class="ruby-identifier">region</span>
            <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">lat</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">latitude</span>
            <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">long</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">longitude</span>
            <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">staticmap</span><span class="ruby-operator">:</span> <span class="ruby-identifier">a</span> <span class="ruby-identifier">url</span> <span class="ruby-identifier">to</span> <span class="ruby-identifier">google</span> <span class="ruby-identifier">static</span> <span class="ruby-identifier">maps</span>
            }
  <span class="ruby-identifier">maxdepth</span><span class="ruby-operator">:</span> <span class="ruby-identifier">integer</span> (<span class="ruby-identifier">m</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ft</span>)
  <span class="ruby-identifier">duration</span><span class="ruby-operator">:</span> <span class="ruby-identifier">integer</span> (<span class="ruby-identifier">minutes</span>)
  <span class="ruby-identifier">time_in</span><span class="ruby-operator">:</span> <span class="ruby-constant">HH</span>:<span class="ruby-constant">MM</span> (<span class="ruby-identifier">local</span> <span class="ruby-identifier">time</span> <span class="ruby-identifier">of</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">dive</span> <span class="ruby-identifier">always</span> <span class="ruby-value">24</span><span class="ruby-operator">-</span><span class="ruby-identifier">hrs</span>)
  <span class="ruby-identifier">date</span><span class="ruby-operator">:</span> <span class="ruby-constant">YYYY</span><span class="ruby-operator">-</span><span class="ruby-constant">MM</span><span class="ruby-operator">-</span><span class="ruby-constant">DD</span>
  <span class="ruby-identifier">profile</span><span class="ruby-operator">:</span> <span class="ruby-identifier">url</span> <span class="ruby-identifier">of</span> <span class="ruby-identifier">png</span> <span class="ruby-identifier">image</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">type</span><span class="ruby-operator">:</span> [<span class="ruby-identifier">type1</span>,<span class="ruby-identifier">type2</span><span class="ruby-operator">...</span>] <span class="ruby-identifier">as</span> <span class="ruby-constant">JSON</span> <span class="ruby-constant">ARRAY</span>
  <span class="ruby-identifier">visibility</span><span class="ruby-operator">:</span> <span class="ruby-identifier">string</span> <span class="ruby-identifier">bad</span><span class="ruby-operator">|</span><span class="ruby-identifier">average</span><span class="ruby-operator">|</span><span class="ruby-identifier">good</span><span class="ruby-operator">|</span><span class="ruby-identifier">excellent</span>
  <span class="ruby-identifier">water</span><span class="ruby-operator">:</span> <span class="ruby-identifier">string</span> <span class="ruby-identifier">salt</span><span class="ruby-operator">|</span><span class="ruby-identifier">fresh</span>
  <span class="ruby-identifier">altitude</span><span class="ruby-operator">:</span> <span class="ruby-identifier">integer</span> (<span class="ruby-keyword">in</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ft</span>)
  <span class="ruby-identifier">buddy</span> =<span class="ruby-operator">&gt;</span> [{ <span class="ruby-identifier">name</span>, <span class="ruby-identifier">url</span>, <span class="ruby-identifier">id</span>},{}<span class="ruby-operator">...</span>{}]
  <span class="ruby-identifier">dive_shop</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">dive</span> <span class="ruby-identifier">shop</span> <span class="ruby-identifier">nae</span>, <span class="ruby-identifier">guide</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">guide</span>, <span class="ruby-identifier">url</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">url</span> }
  <span class="ruby-identifier">pictures</span> =<span class="ruby-operator">&gt;</span> [{<span class="ruby-identifier">id</span>, <span class="ruby-identifier">title</span>, <span class="ruby-identifier">species</span>=<span class="ruby-operator">&gt;</span>[{<span class="ruby-identifier">sname</span>, <span class="ruby-identifier">cname</span>, <span class="ruby-identifier">id</span> (<span class="ruby-identifier">s</span><span class="ruby-operator">-</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">c</span><span class="ruby-operator">-</span>)},{}<span class="ruby-operator">...</span> ]}]
  <span class="ruby-identifier">species</span> =<span class="ruby-operator">&gt;</span> [{<span class="ruby-identifier">sname</span>, <span class="ruby-identifier">cname</span>, <span class="ruby-identifier">id</span> (<span class="ruby-identifier">s</span><span class="ruby-operator">-</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">c</span><span class="ruby-operator">-</span>), <span class="ruby-identifier">url</span> (<span class="ruby-identifier">to</span> <span class="ruby-identifier">picture</span>)},{}<span class="ruby-operator">...</span> ]
  <span class="ruby-identifier">gear</span> =<span class="ruby-operator">&gt;</span> [{<span class="ruby-identifier">type</span>, <span class="ruby-identifier">manufacturer</span>, <span class="ruby-identifier">model</span>},<span class="ruby-operator">...</span>,{}]

}
</pre>
</li></ul>
</dd><dt>Errors
<dd>
<p>TODO: document errors</p>
</dd></dl>
          

          
          <div class="method-source-code" id="list_dive_details-source">
            <pre><span class="ruby-comment"># File ../../app/controllers/api_controller.rb, line 284</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">list_dive_details</span>
  <span class="ruby-keyword">begin</span>
    
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;missing token&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:token</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">AuthTokens</span>.<span class="ruby-identifier">get_user</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:token</span>])
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:units</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:units</span>].<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;imperial&quot;</span>
      <span class="ruby-identifier">unit</span> = <span class="ruby-value">1</span> <span class="ruby-comment">##imperial units</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">unit</span> = <span class="ruby-value">0</span> <span class="ruby-comment">## SI units</span>
    <span class="ruby-keyword">end</span>
    
    
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;no dives were requested&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:divelist</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">dive_list</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">JSON</span>.<span class="ruby-identifier">decode</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:divelist</span>])
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgummentError</span>, <span class="ruby-string">&quot;wrong dive array&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">dive_list</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Array</span>
    <span class="ruby-identifier">dive_details</span> = []
    
    <span class="ruby-identifier">dive_list</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dive_id</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgummentError</span>, <span class="ruby-string">&quot;dive numbers must be integers&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">dive_id</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">Integer</span>
      <span class="ruby-identifier">dive</span> = <span class="ruby-constant">Dive</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">dive_id</span>)
      <span class="ruby-identifier">dive_details</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">to_hash</span>(<span class="ruby-identifier">unit</span>, (<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span><span class="ruby-operator">==</span><span class="ruby-identifier">dive</span>.<span class="ruby-identifier">user_id</span>))   
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Generate a dive list of #{dive_details.count} dives&quot;</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:dives</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dive_details</span>}
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:dives</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dive_details</span>, <span class="ruby-value">:callback</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] }
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">rescue</span>
    <span class="ruby-comment">#trace the error</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">$!</span>.<span class="ruby-identifier">backtrace</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- list_dive_details-source -->
          
        </div>

        

        
      </div><!-- list_dive_details-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- LIST_DIVE_DETAILS+API -->

  
  
  <section id="LIST_USER_DIVES+API" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        LIST_USER_DIVES API
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
     <section id="public-instance-LIST_USER_DIVES+API-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-list_user_dives" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">list_user_dives</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <dl class="rdoc-list label-list"><dt>General
<dd><ul><li>
<p>API url : /api/list_user_dives</p>
</li><li>
<p>List the dives for a user</p>
</li><li>
<p>If user != me, only returns public data</p>
</li></ul>
</dd><dt>Authentication
<dd><ul><li>
<p>Required</p>
</li><li>
<p>GET Call</p>
</li></ul>
</dd><dt>Request - case FB
<dd><ul><li>
<p><strong>token</strong> : User's Token on Diveboard (as provided by login
API)</p>
</li><li>
<p><strong>apikey</strong>: the application's API key</p>
</li><li>
<p>userid: the user’s id you want to list the dives from. default is “me”</p>
</li><li>
<p>callback: the callback function (if supplied it will be responded using
jsonp)</p>
</li><li>
<p>units: “imperial” or “si” (default)</p>
</li></ul>
</dd><dt>Response
<dd><ul><li>
<p><strong>success</strong> : boolean, false if failure</p>
</li><li>
<p>error : string defining the error (only present if success==false)</p>
</li><li>
<p>error_tag : uid of the error (only present if success==false)</p>
</li><li>
<p><strong>dives</strong> : JSON object formatted as follow ordered by time.
If listing dives from a different user than "me", only plublic dives will
appear</p>

<pre>{
  id:dive_id, 
  status:&quot;private&quot;|&quot;public&quot;, 
  date:YYYY-MM-DD, 
  depth:XX, 
  duration: XX, 
  tripname: &quot;mytrip&quot;, 
  status: &quot;draft&quot;|&quot;complete&quot;, 
  country: country_name, 
  location: location_name, 
  name: spot_name
}</pre>
</li></ul>
</dd><dt>Errors
<dd>
<p>TODO: document errors</p>
</dd></dl>
          

          
          <div class="method-source-code" id="list_user_dives-source">
            <pre><span class="ruby-comment"># File ../../app/controllers/api_controller.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">list_user_dives</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;missing token&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:token</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">AuthTokens</span>.<span class="ruby-identifier">get_user</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:token</span>])
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:userid</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">owner</span> = <span class="ruby-identifier">user</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">owner</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:userid</span>].<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;Could not find the dives owner&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">owner</span>.<span class="ruby-identifier">blank?</span>
     
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:units</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:units</span>].<span class="ruby-identifier">downcase</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;imperial&quot;</span>
      <span class="ruby-identifier">unit</span> = <span class="ruby-value">1</span> <span class="ruby-comment">##imperial units</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">unit</span> = <span class="ruby-value">0</span> <span class="ruby-comment">## SI units</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">dives_object</span> = []
    <span class="ruby-identifier">user</span>.<span class="ruby-identifier">ordered_dives</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dive</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">privacy</span> <span class="ruby-operator">==</span><span class="ruby-value">0</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">dive</span>.<span class="ruby-identifier">privacy</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">owner</span>.<span class="ruby-identifier">id</span>  )
        <span class="ruby-identifier">dives_object</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">id</span>,  <span class="ruby-value">:privacy</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-keyword">if</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">privacy</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">then</span> <span class="ruby-string">&quot;public&quot;</span> <span class="ruby-keyword">else</span> <span class="ruby-string">&quot;private&quot;</span> <span class="ruby-keyword">end</span>), <span class="ruby-value">:date</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">date</span>, <span class="ruby-value">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">duration</span>.<span class="ruby-identifier">round</span>, <span class="ruby-value">:depth</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">dive</span>.<span class="ruby-identifier">maxdepth</span> <span class="ruby-identifier">unit</span>).<span class="ruby-identifier">to_f</span>.<span class="ruby-identifier">round</span>(<span class="ruby-value">1</span>), <span class="ruby-value">:tripname</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">dive</span>.<span class="ruby-identifier">trip_name</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">trip_name</span>.<span class="ruby-identifier">titleize</span> <span class="ruby-keyword">else</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">end</span>, <span class="ruby-value">:status</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-keyword">if</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">complete?</span> <span class="ruby-keyword">then</span> <span class="ruby-string">&quot;complete&quot;</span> <span class="ruby-keyword">else</span> <span class="ruby-string">&quot;draft&quot;</span><span class="ruby-keyword">end</span>), <span class="ruby-value">:country</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">begin</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">spot</span>.<span class="ruby-identifier">country</span>.<span class="ruby-identifier">cname</span>.<span class="ruby-identifier">titleize</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">end</span>, <span class="ruby-value">:location</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">begin</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">spot</span>.<span class="ruby-identifier">location</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">titleize</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">end</span>, <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">begin</span> <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">spot</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">titleize</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">end</span>}
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Generate a dive list of #{dives_object.count} items&quot;</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:dives</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dives_object</span>}
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:dives</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dives_object</span>, <span class="ruby-value">:callback</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] }
    <span class="ruby-keyword">end</span>
    
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-comment">#trace the error</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">$!</span>.<span class="ruby-identifier">backtrace</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- list_user_dives-source -->
          
        </div>

        

        
      </div><!-- list_user_dives-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- LIST_USER_DIVES+API -->

  
  
  <section id="LOGIN_FB" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        LOGIN_FB
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
     <section id="public-instance-LOGIN_FB-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-login_fb" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">login_fb</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <dl class="rdoc-list label-list"><dt>General
<dd><ul><li>
<p>API url : /api/login_fb</p>
</li><li>
<p>Logs a user by checking fbtoken + fbid OR email+password</p>
</li><li>
<p>Gives a token valid for 1 month</p>
</li></ul>
</dd><dt>Authentication
<dd><ul><li>
<p>NOT Required</p>
</li><li>
<p>POST Call</p>
</li></ul>
</dd><dt>Request - case FB
<dd><ul><li>
<p><strong>fbid</strong> : User's Facebook ID</p>
</li><li>
<p><strong>fbtoken</strong> : User's Facebook Token (as given by facebook)</p>
</li><li>
<p><strong>apikey</strong>: the application's API key</p>
</li><li>
<p>callback: the callback function (if supplied it will be responded using
jsonp)</p>
</li></ul>
</dd><dt>Response
<dd><ul><li>
<p><strong>success</strong> : boolean, false if failure</p>
</li><li>
<p>error : string defining the error (only present if success==false)</p>
</li><li>
<p>error_tag : uid of the error (only present if success==false)</p>
</li><li>
<p><strong>token</strong> : string with the authentication token to use</p>
</li><li>
<p><strong>expiration</strong>: Date when the token expires - 1day (prevent
all timezone craze)</p>
</li></ul>
</dd><dt>Errors
<dd>
<p>TODO: document errors</p>
</dd></dl>
          

          
          <div class="method-source-code" id="login_fb-source">
            <pre><span class="ruby-comment"># File ../../app/controllers/api_controller.rb, line 53</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">login_fb</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;missing fbid or fbtoken&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:fbid</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:fbtoken</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-comment"># we need to check this token</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;checking if token #{params[:fbtoken]} belongs to user #{params[:fbid]}&quot;</span>
    <span class="ruby-ivar">@graph</span> = <span class="ruby-constant">Koala</span><span class="ruby-operator">::</span><span class="ruby-constant">Facebook</span><span class="ruby-operator">::</span><span class="ruby-constant">GraphAPI</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:fbtoken</span>]) <span class="ruby-comment"># create the graph objet</span>
    <span class="ruby-identifier">profile</span>= <span class="ruby-ivar">@graph</span>.<span class="ruby-identifier">get_object</span>(<span class="ruby-string">&quot;me&quot;</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;fbid and fbtoken don't match&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">profile</span>[<span class="ruby-string">&quot;id&quot;</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:fbid</span>].<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_fb_id</span>(<span class="ruby-identifier">profile</span>[<span class="ruby-string">&quot;id&quot;</span>].<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-comment">## TODO we need to create the user</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-value">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;You need to head over divebord.com and create an account first&quot;</span>}
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">authtoken</span> = <span class="ruby-constant">AuthTokens</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:user_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:expires</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">from_now</span>)
    <span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">update_token</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Generated token #{authtoken.token} for user #{user.id} #{user.vanity_url}&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:token</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">token</span>, <span class="ruby-value">:expiration</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">expires</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>)}
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:token</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">token</span>, <span class="ruby-value">:expiration</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">expires</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>), <span class="ruby-value">:callback</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] }
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-comment">#trace the error</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">$!</span>.<span class="ruby-identifier">backtrace</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- login_fb-source -->
          
        </div>

        

        
      </div><!-- login_fb-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- LOGIN_FB -->

  
  
  <section id="LOGIN_email" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        LOGIN_email
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
     <section id="public-instance-LOGIN_email-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-login_email" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">login_email</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <dl class="rdoc-list label-list"><dt>General
<dd><ul><li>
<p>API url : /api/login_email</p>
</li><li>
<p>Logs a user by checking fbtoken + fbid OR email+password</p>
</li><li>
<p>ives a token valid for 1 month</p>
</li></ul>
</dd><dt>Authentication
<dd><ul><li>
<p>NOT Required</p>
</li><li>
<p>POST Call</p>
</li></ul>
</dd><dt>Request - case FB
<dd><ul><li>
<p><strong>email</strong> : User's login (email)</p>
</li><li>
<p><strong>password</strong> : User's password</p>
</li><li>
<p><strong>apikey</strong>: the application's API key</p>
</li><li>
<p>callback: the callback function (if supplied it will be responded using
jsonp)</p>
</li></ul>
</dd><dt>Response
<dd><ul><li>
<p><strong>success</strong> : boolean, false if failure</p>
</li><li>
<p>error : string defining the error (only present if success==false)</p>
</li><li>
<p>error_tag : uid of the error (only present if success==false)</p>
</li><li>
<p><strong>token</strong> : string with the authentication token to use</p>
</li><li>
<p><strong>expiration</strong>: Date when the token expires - 1day (prevent
all timezone craze)</p>
</li></ul>
</dd><dt>Errors
<dd>
<p>TODO: document errors</p>
</dd></dl>
          

          
          <div class="method-source-code" id="login_email-source">
            <pre><span class="ruby-comment"># File ../../app/controllers/api_controller.rb, line 115</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">login_email</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;missing login or password&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:email</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:password</span>].<span class="ruby-identifier">blank?</span>
    
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">authenticate</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:email</span>].<span class="ruby-identifier">downcase</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:password</span>]))<span class="ruby-operator">==</span><span class="ruby-keyword">false</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;wrong login/password combination&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">authtoken</span> = <span class="ruby-constant">AuthTokens</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:user_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:expires</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">from_now</span>)
    <span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">update_token</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Generated token #{authtoken.token} for user #{user.id} #{user.vanity_url}&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:token</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">token</span>, <span class="ruby-value">:expiration</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">expires</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>)}
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:token</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">token</span>, <span class="ruby-value">:expiration</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">authtoken</span>.<span class="ruby-identifier">expires</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span>), <span class="ruby-value">:callback</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] }
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-comment">#trace the error</span>
    <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">$!</span>.<span class="ruby-identifier">backtrace</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- login_email-source -->
          
        </div>

        

        
      </div><!-- login_email-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- LOGIN_email -->

  
  
  <section id="UPDATE_DIVE_DETAILS+API" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        UPDATE_DIVE_DETAILS API
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
     <section id="public-instance-UPDATE_DIVE_DETAILS+API-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-update_dive" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_dive</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <dl class="rdoc-list label-list"><dt>General
<dd><ul><li>
<p>API url : /api/update_dive</p>
</li><li>
<p>Updated or creates a dive *ALL DATA MUST BE SUBMITTED IN SI!!!*</p>
</li></ul>
</dd><dt>Authentication
<dd><ul><li>
<p>Required</p>
</li><li>
<p>POST Call</p>
</li></ul>
</dd><dt>Request
<dd><ul><li>
<p><strong>token</strong> : User's Token on Diveboard (as provided by login
API)</p>
</li><li>
<p><strong>apikey</strong>: the application's API key</p>
</li><li>
<p>callback: the callback function (if supplied it will be responded using
jsonp)</p>
</li><li>
<p>id: the dive id - if left blank a new dive will be created</p>
</li><li>
<p><strong>date</strong> : string in YYYY-MM-DD format</p>
</li><li>
<p><strong>time_in_hrs</strong> : integer (0-24)</p>
</li><li>
<p><strong>time_in_mins</strong>: integer (0-60)</p>
</li><li>
<p><strong>duration</strong>: integer - in minutes</p>
</li><li>
<p>update_profile: if set to “DELETE” will erase the profile data attached to
the dive if set to “UPDATE” then will update with a previously updated dive
profile</p>
</li><li>
<p>fileid: profile file id as profided by the profile update api needed for
update_profile = UPDATE</p>
</li><li>
<p>diveid: something related to the profile update api  (Pascal ?) needed for
update_profile = UPDATE</p>
</li><li>
<p><strong>spot_id</strong>: the spot id</p>
</li><li>
<p>number: the dive number (like in numbering dives in a logbook - can be any
number actually)</p>
</li><li>
<p><strong>max_depth</strong>: the max depth of the dive</p>
</li><li>
<p>safetystops: an JSON array with the stops i.e. [["5","3"],["3","3"]]
ordered [depth, duration]</p>
</li><li>
<p>notes: a string with the dive notes</p>
</li><li>
<p>surface_temp : a float of the surface temperature (air)</p>
</li><li>
<p>bottom_temp : a float of the bottom temperature (water)</p>
</li><li>
<p>weights: a float in kg</p>
</li><li>
<p>divetype: a json array of divetypes. ["recreational","photo"]
(recreational, photography…) and everything else</p>
</li><li>
<p>fish_list: comma separated list of fish ids i.e
“c-161567,c-174391,c-318949,c-86144,c-32797,s-204729,s-210862,s-223054,s-216583,s-218223,s-24351”</p>
</li><li>
<p>pictures: a JSON array of pricture objects</p>

<pre class="ruby">[{
  <span class="ruby-identifier">id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">picture</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">-</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">blank</span> <span class="ruby-identifier">a</span> <span class="ruby-identifier">new</span> <span class="ruby-identifier">picture</span> <span class="ruby-identifier">will</span> <span class="ruby-identifier">be</span> <span class="ruby-identifier">created</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">update</span>, 
  <span class="ruby-identifier">image</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">url</span> <span class="ruby-identifier">to</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">actual</span> <span class="ruby-identifier">image</span> (<span class="ruby-identifier">jpeg</span><span class="ruby-operator">...</span>), 
  <span class="ruby-identifier">link</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pointer</span> <span class="ruby-identifier">to</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">origin</span> <span class="ruby-identifier">of</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">image</span> (<span class="ruby-identifier">outside</span> <span class="ruby-identifier">diveboard</span>), 
  <span class="ruby-identifier">notes</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">a</span> <span class="ruby-identifier">title</span> <span class="ruby-keyword">for</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">image</span>,
  <span class="ruby-identifier">tags</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">an</span> <span class="ruby-identifier">array</span> <span class="ruby-identifier">of</span> <span class="ruby-identifier">fish</span> <span class="ruby-identifier">ids</span> <span class="ruby-identifier">present</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">picture</span>[{<span class="ruby-identifier">id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">fish</span> <span class="ruby-identifier">id</span> }],
  <span class="ruby-identifier">exif</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">JSON</span> <span class="ruby-identifier">array</span> <span class="ruby-identifier">of</span> <span class="ruby-identifier">exif</span> <span class="ruby-identifier">tags</span> (<span class="ruby-identifier">experimental</span>)
}]
</pre>
</li><li>
<p>gear: JSON array of objects</p>

<pre class="ruby">[{
  <span class="ruby-string">'id'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dive</span> <span class="ruby-identifier">id</span>,
  *<span class="ruby-keyword">class</span>* =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'UserGear'</span> (<span class="ruby-identifier">owned</span>) <span class="ruby-keyword">or</span> <span class="ruby-string">'DiveGear'</span> (<span class="ruby-identifier">rented</span>)
  *<span class="ruby-identifier">category</span>* =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">one</span> <span class="ruby-identifier">of</span> <span class="ruby-identifier">those</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;BCD&quot;</span>, <span class="ruby-string">&quot;Boots&quot;</span>, <span class="ruby-string">&quot;Camera&quot;</span>, <span class="ruby-string">&quot;Compass&quot;</span>, <span class="ruby-string">&quot;Computer&quot;</span>, <span class="ruby-string">&quot;Cylinder&quot;</span>, <span class="ruby-string">&quot;Dive skin&quot;</span>, <span class="ruby-string">&quot;Dry suit&quot;</span>, <span class="ruby-string">&quot;Fins&quot;</span>, <span class="ruby-string">&quot;Gloves&quot;</span>, <span class="ruby-string">&quot;Hood&quot;</span>, <span class="ruby-string">&quot;Knife&quot;</span>, <span class="ruby-string">&quot;Lift bag&quot;</span>, <span class="ruby-string">&quot;Light&quot;</span>, <span class="ruby-string">&quot;Mask&quot;</span>, <span class="ruby-string">&quot;Other&quot;</span>, <span class="ruby-string">&quot;Rebreather&quot;</span>, <span class="ruby-string">&quot;Regulator&quot;</span>, <span class="ruby-string">&quot;Scooter&quot;</span>, <span class="ruby-string">&quot;Wet suit&quot;</span>,
  *<span class="ruby-identifier">manufacturer</span>* =<span class="ruby-operator">&gt;</span> {:<span class="ruby-keyword">class</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">String</span>, :<span class="ruby-identifier">presence</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>},
  *<span class="ruby-identifier">model</span>* =<span class="ruby-operator">&gt;</span> {:<span class="ruby-keyword">class</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">String</span>, :<span class="ruby-identifier">presence</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>},
  *<span class="ruby-identifier">featured</span>* =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">boolean</span>, <span class="ruby-keyword">true</span> <span class="ruby-keyword">or</span> <span class="ruby-keyword">false</span>
}]
</pre>
</li><li>
<p>diveshop: JSON object</p>

<pre class="ruby">{
   *<span class="ruby-identifier">name</span>* =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">shop</span> <span class="ruby-identifier">name</span>
   <span class="ruby-identifier">url</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">shop</span><span class="ruby-string">'s url
   guide =&gt; the guide'</span><span class="ruby-identifier">s</span> <span class="ruby-identifier">name</span> <span class="ruby-identifier">at</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">dive</span> <span class="ruby-identifier">shop</span>
}
</pre>
</li><li>
<p>divebuddy: JSON Array</p>

<pre class="ruby">[{
    *<span class="ruby-identifier">name</span>* =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">buddy</span><span class="ruby-string">'s name
    email =&gt; buddy'</span><span class="ruby-identifier">s</span> <span class="ruby-identifier">email</span>
    <span class="ruby-identifier">fb_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">buddy</span><span class="ruby-string">'s facebook id
    db_id =&gt; buddy'</span><span class="ruby-identifier">s</span> <span class="ruby-identifier">divboard</span> <span class="ruby-identifier">id</span>
    <span class="ruby-identifier">picturl</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">url</span> <span class="ruby-identifier">to</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">user</span><span class="ruby-string">'s pict (deprecated)
}]
</span></pre>
</li><li>
<p>altitude: the altitude of the dive in m (float)</p>
</li><li>
<p>water: the water type “salt or ”fresh“ or ”“</p>
</li><li>
<p>visibility:  “bad” “good” “average” “excellent” or “”</p>
</li><li>
<p>current: “light” “medium” “strong” “extrme” or “”</p>
</li><li>
<p>trip name: string with the name of the current trip</p>
</li><li>
<p>dan_data: TODO : document the object</p>
</li><li>
<p>send_to_dan: ‘true’ &gt; Data WILL BE sent to dan by Diveboard</p>
</li><li>
<p>tanks: JSON array</p>

<pre class="ruby">[{
   *<span class="ruby-identifier">material</span>* =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;aluminium&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-string">&quot;steel&quot;</span>
   *<span class="ruby-identifier">gas</span>* =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;air&quot;</span> <span class="ruby-string">&quot;EANx32&quot;</span> <span class="ruby-string">&quot;EANx36&quot;</span> <span class="ruby-string">&quot;EANx40&quot;</span> <span class="ruby-string">&quot;custom&quot;</span>
   <span class="ruby-identifier">volume</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">in</span> <span class="ruby-constant">L</span>
   <span class="ruby-identifier">p_start</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pressure</span> <span class="ruby-identifier">start</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">bar</span>
   <span class="ruby-identifier">p_end</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pressure</span> <span class="ruby-keyword">end</span> <span class="ruby-keyword">in</span> <span class="ruby-identifier">bar</span>
   <span class="ruby-identifier">order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">nth</span> <span class="ruby-identifier">tank</span> <span class="ruby-identifier">used</span> <span class="ruby-identifier">during</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">dive</span>
   <span class="ruby-identifier">o2</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">%Qof </span><span class="ruby-constant">O2</span> (<span class="ruby-identifier">integer</span>)
   <span class="ruby-identifier">n2</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">%Qof </span><span class="ruby-constant">N2</span>
   <span class="ruby-identifier">he</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">%Qof </span><span class="ruby-constant">He</span>
   <span class="ruby-identifier">time</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">time</span> <span class="ruby-identifier">of</span> <span class="ruby-identifier">the</span> <span class="ruby-identifier">dive</span> (<span class="ruby-keyword">in</span> <span class="ruby-identifier">minutes</span>) <span class="ruby-keyword">when</span> <span class="ruby-identifier">user</span> <span class="ruby-identifier">switched</span> <span class="ruby-identifier">to</span> <span class="ruby-identifier">this</span> <span class="ruby-identifier">tank</span>
   <span class="ruby-identifier">multitank</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> = <span class="ruby-identifier">single</span> <span class="ruby-identifier">tank</span>, <span class="ruby-value">2</span> = <span class="ruby-identifier">double</span> <span class="ruby-identifier">tank</span>
}]
</pre>
</li></ul>
</dd><dt>Response
<dd><ul><li>
<p><strong>success</strong> : boolean, false if failure</p>
</li><li>
<p>error : string defining the error (only present if success==false)</p>
</li><li>
<p>error_tag : uid of the error (only present if success==false) - not present
for jsonp</p>
</li><li>
<p><strong>diveid</strong> : the dive id</p>
</li><li>
<p>messages : messages if some values could not be saved</p>
</li></ul>
</dd><dt>Errors
<dd>
<p>TODO: document errors</p>
</dd></dl>
          

          
          <div class="method-source-code" id="update_dive-source">
            <pre><span class="ruby-comment"># File ../../app/controllers/api_controller.rb, line 491</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_dive</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;missing token&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:token</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">user</span> = <span class="ruby-constant">AuthTokens</span>.<span class="ruby-identifier">get_user</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:token</span>]) <span class="ruby-comment">#needed to check permissions</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">blank?</span>
        <span class="ruby-identifier">dive</span> = <span class="ruby-constant">Dive</span>.<span class="ruby-identifier">new</span>(
         <span class="ruby-value">:spot_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>,
         <span class="ruby-value">:time_in</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;2011-01-01&quot;</span>.<span class="ruby-identifier">to_datetime</span> 
        )
        <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">user_id</span> = <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Create new dive for user #{@user.id}&quot;</span>
        <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">privacy</span> = <span class="ruby-value">1</span> <span class="ruby-comment"># by default privacy is set to 1 = &quot;private&quot; ##TODO## bind to settings</span>
        <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">spot_id</span> = <span class="ruby-value">1</span> <span class="ruby-comment">#by default we bind it to spot 1 - this prevents potential issues of a dive existing without a spot</span>
        <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">auto_number</span>
        <span class="ruby-identifier">dive</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">dive</span> = <span class="ruby-constant">Dive</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">to_i</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">render</span> (<span class="ruby-constant">DiveinfoController</span>.<span class="ruby-identifier">new</span>).<span class="ruby-identifier">update_dive</span>(<span class="ruby-identifier">dive</span>, <span class="ruby-identifier">params</span>, <span class="ruby-identifier">user</span>)
      <span class="ruby-keyword">rescue</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>, <span class="ruby-string">'Could not update dive - 500'</span>
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">rescue</span>
      <span class="ruby-comment">#trace the error</span>
      <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">$!</span>.<span class="ruby-identifier">backtrace</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span></pre>
          </div><!-- update_dive-source -->
          
        </div>

        

        
      </div><!-- update_dive-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- UPDATE_DIVE_DETAILS+API -->

  
  
  <section id="UPDATE_SPOT+API" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        UPDATE_SPOT API
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
     <section id="public-instance-UPDATE_SPOT+API-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-update_spot" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_spot</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <dl class="rdoc-list label-list"><dt>General
<dd><ul><li>
<p>API url : /api/update_spot</p>
</li><li>
<p>Will update an existing spot or create a new one</p>
</li><li>
<p>If updating, the spot will be only seen by the user who updated it until it
has been manually moderated and will become available publicly</p>
</li></ul>
</dd><dt>Authentication
<dd><ul><li>
<p>Required</p>
</li><li>
<p>POST Call</p>
</li></ul>
</dd><dt>Request - case FB
<dd><ul><li>
<p><strong>token</strong> : User's Token on Diveboard (as provided by login
API)</p>
</li><li>
<p><strong>apikey</strong>: the application's API key</p>
</li><li>
<p>id: the spot id -  if not provided the spot will be created, otherwise it
will be updated. id has to be valid in that case</p>
</li><li>
<p><strong>country</strong> : the country code as in <a
href="http://www.diveboard.com/js/countries.en.js">www.diveboard.com/js/countries.en.js</a></p>
</li><li>
<p><strong>location</strong> : the area where the spot is located (a big city
or a common name to the area)</p>
</li><li>
<p>region: the body of water where the spot is</p>
</li><li>
<p><strong>lat</strong>: the latitude (must be a float)</p>
</li><li>
<p><strong>lng</strong>: the longitude (must be a float)</p>
</li><li>
<p>description: free field</p>
</li><li>
<p>zoom: the level of zoom to give a nice view of the spot in gmaps (default
will be at 9)</p>
</li><li>
<p>callback: the callback function (if supplied it will be responded using
jsonp)</p>
</li></ul>
</dd><dt>Response
<dd><ul><li>
<p><strong>success</strong> : boolean, false if failure</p>
</li><li>
<p>error : string defining the error (only present if success==false)</p>
</li><li>
<p>error_tag : uid of the error (only present if success==false)</p>
</li><li>
<p><strong>id</strong> : the updated/created spot id (can be used in
subsequent calls) - warning ! after xx mins the id can change following the
moderation process</p>
</li></ul>
</dd><dt>Errors
<dd>
<p>TODO: document errors</p>
</dd></dl>
          

          
          <div class="method-source-code" id="update_spot-source">
            <pre><span class="ruby-comment"># File ../../app/controllers/api_controller.rb, line 361</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_spot</span>
   <span class="ruby-keyword">begin</span>
     <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;missing token&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:token</span>].<span class="ruby-identifier">blank?</span>
     <span class="ruby-identifier">user</span> = <span class="ruby-constant">AuthTokens</span>.<span class="ruby-identifier">get_user</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:token</span>])
     
     <span class="ruby-identifier">spot</span> = <span class="ruby-constant">Spot</span>.<span class="ruby-identifier">new</span>
     <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">blank?</span>
       <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">moderate_id</span> = <span class="ruby-constant">Spot</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">id</span>
     <span class="ruby-keyword">end</span>
     
     <span class="ruby-identifier">update_spot_from_params</span> <span class="ruby-identifier">spot</span>
     
     <span class="ruby-identifier">spot</span>.<span class="ruby-identifier">save!</span>
     
     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
       <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:dives</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dive_details</span>}
     <span class="ruby-keyword">else</span>
       <span class="ruby-identifier">render</span> <span class="ruby-value">:js</span> =<span class="ruby-operator">&gt;</span> {<span class="ruby-value">:success</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:dives</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dive_details</span>, <span class="ruby-value">:callback</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] }
     <span class="ruby-keyword">end</span>

   <span class="ruby-keyword">rescue</span>
     <span class="ruby-comment">#trace the error</span>
     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-identifier">$!</span>.<span class="ruby-identifier">backtrace</span>
     <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>].<span class="ruby-identifier">blank?</span>
       <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
     <span class="ruby-keyword">else</span>
       <span class="ruby-identifier">render</span> <span class="ruby-identifier">api_exception</span> <span class="ruby-identifier">$!</span>
     <span class="ruby-keyword">end</span>
     <span class="ruby-keyword">return</span>
   <span class="ruby-keyword">end</span>
 <span class="ruby-keyword">end</span></pre>
          </div><!-- update_spot-source -->
          
        </div>

        

        
      </div><!-- update_spot-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- UPDATE_SPOT+API -->

  
  
  <section id="USER+RELATED+API" class="documentation-section">
    
    <div class="documentation-section-title">
      <h2 class="section-header">
        USER RELATED API
      </h2>
      <span class="section-click-top">
        <a href="#top">&uarr; top</a>
      </span>
    </div>
    

    
    <div class="description">
      
    </div>
    

    

    

    <!-- Methods -->
    
  </section><!-- USER+RELATED+API -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

